<!doctype html>
<html lang="ru" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-seq-db/internal/cache" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.7.0">
<title data-rh="true">Cache overview | seq-db docs</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://ozontech.github.io/seq-db-docs/ru/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://ozontech.github.io/seq-db-docs/ru/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://ozontech.github.io/seq-db-docs/ru/seq-db/internal/cache"><meta data-rh="true" property="og:locale" content="ru"><meta data-rh="true" property="og:locale:alternate" content="en"><meta data-rh="true" name="docusaurus_locale" content="ru"><meta data-rh="true" name="docsearch:language" content="ru"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Cache overview | seq-db docs"><meta data-rh="true" name="description" content="Currently, cache system&#x27;s responsibility is to optimize access to index on disk"><meta data-rh="true" property="og:description" content="Currently, cache system&#x27;s responsibility is to optimize access to index on disk"><link data-rh="true" rel="icon" href="/seq-db-docs/ru/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://ozontech.github.io/seq-db-docs/ru/seq-db/internal/cache"><link data-rh="true" rel="alternate" href="https://ozontech.github.io/seq-db-docs/seq-db/internal/cache" hreflang="en"><link data-rh="true" rel="alternate" href="https://ozontech.github.io/seq-db-docs/ru/seq-db/internal/cache" hreflang="ru"><link data-rh="true" rel="alternate" href="https://ozontech.github.io/seq-db-docs/seq-db/internal/cache" hreflang="x-default"><link rel="stylesheet" href="/seq-db-docs/ru/assets/css/styles.f30a109f.css">
<script src="/seq-db-docs/ru/assets/js/runtime~main.fe84de63.js" defer="defer"></script>
<script src="/seq-db-docs/ru/assets/js/main.4ac91b16.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Перейти к основному содержимому"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Перейти к основному содержимому</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Переключить навигационную панель" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/seq-db-docs/ru/"><div class="navbar__logo"><img src="/seq-db-docs/ru/img/logo-dark.svg" alt="seq-db logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/seq-db-docs/ru/img/logo-light.svg" alt="seq-db logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">seq-db</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/seq-db-docs/ru/">Docs</a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_nlXk"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>Русский</a><ul class="dropdown__menu"><li><a href="/seq-db-docs/seq-db/internal/cache" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="en">English</a></li><li><a href="/seq-db-docs/ru/seq-db/internal/cache" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="ru">Русский</a></li></ul></div><a href="https://github.com/ozontech/seq-db" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Переключение между темным и светлым режимом (сейчас используется Светлый режим)" aria-label="Переключение между темным и светлым режимом (сейчас используется Светлый режим)" aria-live="polite" aria-pressed="false"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Прокрутка к началу" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" href="/seq-db-docs/ru/">seq-db</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/seq-db-docs/ru/">Quickstart</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/seq-db-docs/ru/seq-db/flags">Flags</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/seq-db-docs/ru/seq-db/index-types">Index types and mappings</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/seq-db-docs/ru/seq-db/seq-ql">seq-ql</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/seq-db-docs/ru/seq-db/long-term-store">Long term stores</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/seq-db-docs/ru/seq-db/rate-limiting">Rate limiting requests</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/seq-db-docs/ru/seq-db/troubleshooting">Устранение неполадок</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/seq-db-docs/ru/seq-db/public-api">Public API</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/seq-db-docs/ru/seq-db/benchmarks">benchmarks</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" tabindex="0" href="/seq-db-docs/ru/seq-db/internal/cache">Internal</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/seq-db-docs/ru/seq-db/internal/cache">Cache overview</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/seq-db-docs/ru/seq-db/internal/common">Basic moments</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/seq-db-docs/ru/seq-db/internal/debug-server">Debug server</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/seq-db-docs/ru/seq-db/internal/format-docs-meta-file">Format of Documents File and Meta File</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/seq-db-docs/ru/seq-db/internal/format-index-file">Format of Index File of Sealed Fraction</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/seq-db-docs/ru/seq-db/internal/frac-cache">Fraction Cache (.frac-cache)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/seq-db-docs/ru/seq-db/internal/fractions">Factions</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/seq-db-docs/ru/seq-db/internal/parser">How search request parsing works</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/seq-db-docs/ru/seq-db/internal/search">How searching works</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/seq-db-docs/ru/seq-db/internal/tips-and-tricks">Tips and tricks</a></li></ul></li></ul></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Навигационная цепочка  текущей страницы"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Главная страница" class="breadcrumbs__link" href="/seq-db-docs/ru/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">seq-db</span><meta itemprop="position" content="1"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Internal</span><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Cache overview</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">Содержание этой страницы</button></div><div class="theme-doc-markdown markdown"><header><h1>Cache overview</h1></header>
<p>Currently, cache system&#x27;s responsibility is to optimize access to index on disk
by storing in memory recently accessed data, as to avoid excess reads.
Data is stored in most cases in near-raw format, just after unpacking.</p>
<p>Core concepts:</p>
<ul>
<li><code>cache.Cache</code>: single cache instance, mimicking generic map with uint32 keys;</li>
<li><code>cache.bucket</code>: interface, implemented by <code>Cache</code> and used by <code>Cleaner</code>;</li>
<li><code>cache.Cleaner</code>: keeps collection of <code>bucket</code>s, implements cleaning</li>
<li>layer: type of data we are to cache. There&#x27;s six different layers;</li>
<li><code>frac.SealedIndexCache</code>: one for a fraction. Keeps together <code>Cache</code> instances
for this fraction, one per layer;</li>
<li><code>fracmanager.CacheMaintainer</code>: keeps all <code>Cleaner</code>s, is responsible
for maintaining size, logging and creating new <code>SealedIndexCache</code>s.</li>
</ul>
<p>Overall, there are two parallel layouts.</p>
<p>First, every fraction has its own <code>SealedIndexCache</code>, which holds reference
to all related <code>Cache</code> instances, allowing fraction (and its substructures)
access to cache, and to stored on disk index through it.</p>
<p>Second, <code>FracManager</code> holds reference to <code>CacheMaintainer</code> which performs all
the maintenance through respective <code>Cleaner</code>s. Each <code>Cleaner</code> not necessarily
represent single layer, though every layer is maintained by one <code>Cleaner</code>.</p>
<p>Package <code>cache</code> is implemented independently of other packages,
with encapsulation in mind.</p>
<p>On the other hand, <code>SealedIndexCache</code> and <code>CacheMaintainer</code> bind it to
our layers, limits and workflow.</p>
<h1>Cache layers</h1>
<p>See <a href="/seq-db-docs/ru/seq-db/internal/format-index-file">Index File Format</a>.</p>
<p>There are 7 cache layers:</p>
<ul>
<li><code>index</code>: also called <code>Registry</code>, contains information on the fraction index
file layout;</li>
<li><code>tokens</code>: all the tokens from all the indexed fields in docs in fraction;</li>
<li><code>lids</code>: for every token list of lids that match it;</li>
<li><code>docsdocblock</code>: for docblocks read during Fetch;</li>
<li><code>mids</code>, <code>rids</code>, <code>params</code>: mid, rid and position (docs block index, doc offset)
of every lid, allowing to identify and locate corresponding doc.</li>
</ul>
<p><code>Cache</code> instances related to same layer are maintained by the same <code>Cleaner</code>.
There are currently 5 of them in <code>CacheMaintainer</code>:</p>
<ul>
<li><code>lids</code> cleaner: this one is responsible for instances related to <code>lids</code> layer;</li>
<li><code>tokens</code> cleaner: same for <code>tokens</code> layer;</li>
<li><code>index</code> cleaner: same for <code>index</code> layer;</li>
<li><code>docblock</code> cleaner: same for <code>docblock</code> layer</li>
<li><code>mids-rids-params</code> cleaner: this one takes care of other layers, i.e. <code>mids</code>, <code>rids</code> and <code>params</code>.</li>
</ul>
<p>They are separated this way due to their relative loads. <code>lids</code> have very big
values and are accessed often. <code>tokens</code> instead have very big amount of small
values, and are accessed often too. Other layers do not match, and thus can be
combined as to provide some basic level of protection against being purged by
<code>lids</code> or <code>tokens</code>, which in turn require protection from each other.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="layer-sizes">Layer sizes<a href="#layer-sizes" class="hash-link" aria-label="Прямая ссылка на Layer sizes" title="Прямая ссылка на Layer sizes">​</a></h3>
<p>Layers don&#x27;t have prefixed sizes. Instead, each <code>Cleaner</code> is associated with
size restriction. Restrictions are measured in fraction of total cache size:</p>
<ul>
<li><code>lids</code>: 40%</li>
<li><code>tokens</code>: 40%</li>
<li><code>docblock</code>: 8%</li>
<li><code>index</code>: 3%</li>
<li><code>mids-rids-params</code>: 9%</li>
</ul>
<h1>Interface</h1>
<p><code>Cache</code> has one basic access method, that being <code>Get</code>.
It takes the key and the factory function that will be called to create
new value if the key is not present. The value type is generic.</p>
<p>The second access method is <code>GetWithError</code>. This one allows factory function
to return error instead of value, which will not be saved in cache,
but passed through.</p>
<p><code>Cache</code> can store any type of values inside, and <code>SealedIndexCache</code>
holds the exact instances, specialized for layer-related structures.</p>
<h1>Internals</h1>
<p>Current implementation has one <code>mu sync.Mutex</code> for each <code>Cache</code> instance,
serving as a global lock. Under protection of this lock atomic operations
are performed, accessing and modifying the data.</p>
<p>Simple access to cache is designed to take lock only for brief periods of time.
Some other whole-cache-related operations, like getting stats or cleaning,
are allowed to take lock for longer times, given this doesn&#x27;t trouble
simple accesses.</p>
<p>In most cases access requires only one such period. Adding new value
to the cache takes two though. Creation of the corresponding value takes time,
and thus we only need lock in the beginning and in the end. Rarely,
in case of panics (or returned error) in provided factory function,
it can take more lock/unlock cycles.</p>
<p>Data is stored in <code>entry</code> objects, which are referenced from
<code>payload map[uint32]*entry[V]</code>. Entries are organized into generations as to
facilitate cache cleaning process. <code>generations []*Generation</code> are thus
stored in <code>Cleaner</code> instances for this purpose.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="entries">Entries<a href="#entries" class="hash-link" aria-label="Прямая ссылка на Entries" title="Прямая ссылка на Entries">​</a></h3>
<p>Internally, cache operates on <code>entry</code> objects, which represent stored
<code>value V</code> with some cache-related information:</p>
<ul>
<li><code>wg *sync.WaitGroup</code>. This one is of most importance, as it is used to
wait for value creation, and indicates whether it was successful.
It&#x27;s initialized with <code>Add(1)</code>.</li>
<li><code>gen *generation</code> links entry to its generation.
<code>nil</code> until <code>value</code> is loaded. The only one that keeps changing and
cannot be accessed without lock even when <code>wg</code> is <code>nil</code> or waited on.</li>
<li><code>size</code> contains size of the loaded value.</li>
</ul>
<p>All entry changes are done under <code>Cache.mu</code> lock, and between locks
each entry can be in one of the following states:</p>
<ol>
<li>Not present. There&#x27;s no value nor entry for this key,
as it wasn&#x27;t accessed since cache creation, or was cleared.</li>
<li>Entry is present, <code>wg</code> is not <code>nil</code>, but <code>Done()</code> wasn&#x27;t yet called.
It means that this key was recently accessed,
and the value for it is being created right now.
There may be some pending accesses that wait on <code>wg</code>.
<code>gen</code> and <code>size</code> are not initialized.</li>
<li>Entry is present, <code>wg</code> is <code>nil</code>.
This means the entry is valid, and <code>value</code> can be returned.
<code>gen</code> and <code>size</code> have correct values.</li>
<li>Entry has <code>wg</code>, <code>Done()</code> was already called.
This indicates that entry is invalid. In this case it&#x27;s not present
in <code>payload</code> map and exists only because someone may be waiting on it.
Entry gets into this state if the function responsible for value creation
has panicked, or returned error. The entry was then marked as invalid
and removed, and is to be created again by someone else.
<code>gen</code> and <code>size</code> are both not initialized.
Everyone waiting on this <code>wg</code> should reattempt access, possibly creating
new entry themselves.</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="generations">Generations<a href="#generations" class="hash-link" aria-label="Прямая ссылка на Generations" title="Прямая ссылка на Generations">​</a></h3>
<p>For the cleaning purposes, all entries are linked to some generation,
which was stored in <code>Cache.currentGeneration</code> at the moment of such <code>entry</code>
becoming valid or last accessed, whichever happens later.
Entries that are not yet valid don&#x27;t have generation.</p>
<p>All generation-related operations are performed under <code>Cache.mu</code> lock.
Between locks, all <code>generation</code> objects are in one of the three states:</p>
<ul>
<li>Current generation. There&#x27;s always one and only one such generation.
That one is stored in every accessed <code>entry</code>.</li>
<li>Non-current and non-stale generation. Most generations are in this state.
The values linked to these generations were accessed recently enough to
be protected from clearing.</li>
<li>Stale. This state is for generations that are considered old, but were not yet
cleaned because they weren&#x27;t considered big enough.</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="cleaning">Cleaning<a href="#cleaning" class="hash-link" aria-label="Прямая ссылка на Cleaning" title="Прямая ссылка на Cleaning">​</a></h3>
<p>Cleaning consists of two independent process. First one is periodical creation
of new generations, and the second one is periodical marking generations
as stale and consequent cleaning of them.</p>
<p>Each <code>Cleaner</code> instance has set of generations. New generations are created
<code>Cleaner</code>-wide when some known amount (say, 10% of the limit) of new data was stored.
At this moment every <code>Cache</code> instance is instructed to use new generation as current,
thus sealing the last one.</p>
<p>When the <code>Cleaner</code> decides that it has started to exceed its memory limit, it marks the
oldest few generations, which together are large enough to free up memory, as stale.
It then initiates the removal of all stale generations entries from each <code>Cache</code>.</p>
<p>Also time to time <code>Cleaner</code> finds released <code>Cache</code>s and removes it from list as well
as empty generations.</p>
<h1>Metrics</h1>
<p>There are several metrics collected as to check cache health.
Each metric is collected separately for each layer.</p>
<ul>
<li>HitsTotal - access counter, when value was present</li>
<li>MissTotal - access counter, when value was inserted by accessor</li>
<li>MissLatency - counter of seconds me spend getting data when we miss cache</li>
<li>PanicsTotal - access counter, when value wasn&#x27;t inserted by accessor</li>
<li>LockWaitsTotal - number of times initial lock for simple access
wasn&#x27;t acquired immediately, thus forcing rescheduling</li>
<li>WaitTotal - number of times access method had to wait for someone else to
put value into cache</li>
<li>ReattemptsTotal - number of times access method had to reattempt due to entry
invalidation</li>
<li>SizeOccupied - counter of size of the values added to cache on miss</li>
<li>SizeRead - counter of size of the values retrieved on hit</li>
<li>SizeReleased - counter of size of data we released</li>
<li>MapsRecreated - counter of events we recreate cache maps</li>
</ul>
<p>As a rule, <code>TouchTotal = HitsTotal + MissTotal + PanicsTotal</code>.
Also <code>TotalSize = SizeOccupied - SizeReleased</code>.
MissTotal and SizeOccupied are the metrics to optimize cache.
HitsTotal and SizeRead are the metrics to optimize cache use.
Rising WaitTotal means concurrent access to the same not-yet-cached value.</p>
<p>LockWaitsTotal ideally should be near-zero at all times and
shows cache internal efficiency in terms of concurrent access. This is the one
to check when implementing whole-cache-related operations.
PanicsTotal and ReattemptsTotal ideally should be near-zero at all times and
show problems with cache usage.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/ozontech/seq-db/tree/main/website/docs/docs/seq-db/internal/cache.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Отредактировать эту страницу</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Страница документа"><a class="pagination-nav__link pagination-nav__link--prev" href="/seq-db-docs/ru/seq-db/benchmarks"><div class="pagination-nav__sublabel">Предыдущая страница</div><div class="pagination-nav__label">benchmarks</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/seq-db-docs/ru/seq-db/internal/common"><div class="pagination-nav__sublabel">Следующая страница</div><div class="pagination-nav__label">Basic moments</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#layer-sizes" class="table-of-contents__link toc-highlight">Layer sizes</a></li><li><a href="#entries" class="table-of-contents__link toc-highlight">Entries</a></li><li><a href="#generations" class="table-of-contents__link toc-highlight">Generations</a></li><li><a href="#cleaning" class="table-of-contents__link toc-highlight">Cleaning</a></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/seq-db-docs/ru/">Quickstart</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://t.me/file_d_community" target="_blank" rel="noopener noreferrer" class="footer__link-item">Telegram<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/ozontech/seq-db" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 Ozon, Inc. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>